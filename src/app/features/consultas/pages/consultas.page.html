<ion-content [fullscreen]="true">
  <div class="ficha-container">
    <!-- Header con botón de volver -->
    <div class="ficha-header">
      <button class="back-btn" (click)="goBack()">
        <ion-icon name="arrow-back-outline"></ion-icon>
        <span>Volver a Pacientes</span>
      </button>
      
      <div class="header-title-row">
        <div class="header-title">
          <div class="patient-avatar" [style.background-color]="getAvatarColor(ficha?.datosPersonales?.nombres, ficha?.datosPersonales?.apellidos)">
            {{ getInitials(ficha?.datosPersonales?.nombres, ficha?.datosPersonales?.apellidos) }}
          </div>
          <div class="header-text">
            <h1>{{ ficha?.datosPersonales?.nombres }} {{ ficha?.datosPersonales?.apellidos }}</h1>
            <p class="patient-rut">{{ ficha?.datosPersonales?.rut }}</p>
          </div>
        </div>
        
        <div class="header-actions">
          <ion-button (click)="nuevaConsulta()" fill="solid" color="primary" class="nueva-consulta-btn">
            <ion-icon name="add-circle" slot="start"></ion-icon>
            Nueva Consulta
          </ion-button>
          
          <ion-button (click)="verMedicacion()" fill="outline" class="medicacion-btn">
            <ion-icon name="medical" slot="start"></ion-icon>
            Ver Medicación
          </ion-button>
        </div>
      </div>
      
    </div>

    <!-- SECCIÓN: Datos Personales -->
    <ion-card class="section-card">
      <ion-card-header>
        <div class="section-header">
          <ion-icon name="person" class="section-icon"></ion-icon>
          <ion-card-title>Datos Personales</ion-card-title>
          <div *ngIf="!isEditMode">
            <ion-button (click)="editarDatosPersonales()" fill="outline" size="small" class="edit-btn">
              <ion-icon name="create-outline" slot="start"></ion-icon>
              Editar
            </ion-button>
          </div>
          <div *ngIf="isEditMode" class="edit-actions">
            <ion-button (click)="guardarCambios()" fill="solid" size="small" color="success">
              <ion-icon name="checkmark-outline" slot="start"></ion-icon>
              Guardar
            </ion-button>
            <ion-button (click)="cancelarEdicion()" fill="outline" size="small" color="medium">
              <ion-icon name="close-outline" slot="start"></ion-icon>
              Cancelar
            </ion-button>
          </div>
        </div>
      </ion-card-header>
      
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="12" sizeMd="6">
              <div class="info-group">
                <div class="info-item">
                  <span class="info-label">RUT:</span>
                  <span class="info-value">{{ ficha?.datosPersonales?.rut }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Edad:</span>
                  <span class="info-value">{{ ficha?.datosPersonales?.edad }} años</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Tipo sanguíneo:</span>
                  <span class="info-value blood-type" *ngIf="!isEditMode">{{ ficha?.datosPersonales?.grupoSanguineo }}</span>
                  <ion-select *ngIf="isEditMode" [(ngModel)]="editedData.grupoSanguineo" interface="popover">
                    <ion-select-option value="A+">A+</ion-select-option>
                    <ion-select-option value="A-">A-</ion-select-option>
                    <ion-select-option value="B+">B+</ion-select-option>
                    <ion-select-option value="B-">B-</ion-select-option>
                    <ion-select-option value="AB+">AB+</ion-select-option>
                    <ion-select-option value="AB-">AB-</ion-select-option>
                    <ion-select-option value="O+">O+</ion-select-option>
                    <ion-select-option value="O-">O-</ion-select-option>
                  </ion-select>
                </div>
              </div>
            </ion-col>
            <ion-col size="12" sizeMd="6">
              <div class="info-group">
                <div class="info-item">
                  <span class="info-label">Dirección:</span>
                  <span class="info-value" *ngIf="!isEditMode">{{ ficha?.datosPersonales?.direccion }}</span>
                  <ion-input *ngIf="isEditMode" [(ngModel)]="editedData.direccion" type="text" class="edit-input"></ion-input>
                </div>
                <div class="info-item">
                  <span class="info-label">Contacto:</span>
                  <span class="info-value" *ngIf="!isEditMode">{{ ficha?.datosPersonales?.telefono }}</span>
                  <ion-input *ngIf="isEditMode" [(ngModel)]="editedData.telefono" type="tel" maxlength="9" class="edit-input"></ion-input>
                </div>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- SECCIÓN: Alertas Médicas -->
    <ion-card class="section-card">
      <ion-card-header>
        <div class="section-header">
          <ion-icon name="alert-circle" class="section-icon alert-icon"></ion-icon>
          <ion-card-title>Alertas Médicas</ion-card-title>
        </div>
      </ion-card-header>
      
      <ion-card-content>
        <div class="alerts-container">
          <div class="alerts-group">
            <h4 class="alerts-subtitle">Alergias:</h4>
            <div class="badges-container">
              <ion-badge 
                *ngFor="let alerta of ficha?.alertasMedicas | slice:0:2" 
                [color]="getBadgeColor(alerta.criticidad)"
                class="alert-badge">
                {{ alerta.descripcion }}
              </ion-badge>
            </div>
          </div>
          
          <div class="alerts-group">
            <h4 class="alerts-subtitle">Condiciones Crónicas:</h4>
            <div class="badges-container">
              <ion-badge 
                *ngFor="let alerta of ficha?.alertasMedicas | slice:2:4" 
                [color]="getBadgeColor(alerta.criticidad)"
                class="alert-badge condition-badge">
                {{ alerta.descripcion }}
              </ion-badge>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- SECCIÓN: Evolución Médica con Timeline -->
    <ion-card class="section-card timeline-card">
      <ion-card-header>
        <div class="section-header">
          <ion-icon name="pulse" class="section-icon evolution-icon"></ion-icon>
          <ion-card-title>Historial Médico Completo</ion-card-title>
        </div>
      </ion-card-header>
      
      <ion-card-content>
        <app-timeline 
          [items]="timelineItems"
          [emptyMessage]="'No hay consultas o exámenes registrados'">
        </app-timeline>
      </ion-card-content>
    </ion-card>

    <!-- BOTÓN DESTACADO: Ver Exámenes (igual a tab1) -->
    <ion-card class="panel">
      <ion-card-content>
        <button class="alert-btn"(click)="verExamenes()">
          <ion-icon name="flask"></ion-icon>
          <span>Ver Exámenes</span>
        </button>
      </ion-card-content>
    </ion-card>

    <!-- SECCIÓN: Exámenes y Resultados (resumen) -->
    <ion-card class="section-card">
      <ion-card-header>
        <div class="section-header">
          <ion-icon name="flask" class="section-icon examenes-icon"></ion-icon>
          <ion-card-title>Resumen Exámenes y Resultados</ion-card-title>
        </div>
      </ion-card-header>
      <ion-card-content>
        <div class="examenes-list">
          <div *ngFor="let examen of ficha?.examenes" class="examen-item">
            <div class="examen-header">
              <div class="examen-info">
                <h4 class="examen-name">{{ examen.nombre }}</h4>
                <span class="examen-date">{{ formatDateShort(examen.fecha) }}</span>
              </div>
              <ion-badge [color]="getExamenBadgeColor(examen.estado)" class="examen-badge">
                {{ getExamenBadgeText(examen.estado) }}
              </ion-badge>
            </div>
            <div class="examen-result">
              <span>{{ examen.resultado }}</span>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- SECCIÓN: Notas Rápidas -->
    <ion-card class="section-card">
      <ion-card-header>
        <div class="section-header">
          <ion-icon name="document-outline" class="section-icon notas-icon"></ion-icon>
          <ion-card-title>Notas Rápidas</ion-card-title>
        </div>
      </ion-card-header>
      
      <ion-card-content>
        <div class="notas-container">
          <ion-textarea
            [(ngModel)]="nuevaNota"
            placeholder="Agregar nota rápida sobre el paciente..."
            rows="4"
            fill="outline"
            class="nota-textarea">
          </ion-textarea>
          
          <ion-button 
            (click)="agregarNota()"
            [disabled]="!nuevaNota.trim()"
            color="primary"
            class="agregar-nota-btn">
            <ion-icon name="add" slot="start"></ion-icon>
            Agregar Nota
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

  </div>
</ion-content>
