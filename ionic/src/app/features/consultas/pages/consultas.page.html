<ion-content [fullscreen]="true">
  <div class="ficha-container">
    <!-- Header con botón de volver -->
    <div class="ficha-header">
      <button class="back-btn" (click)="goBack()">
        <ion-icon name="arrow-back-outline"></ion-icon>
        <span>Volver a Pacientes</span>
      </button>
      
      <div class="header-title-row">
        <div class="header-title">
          <div class="patient-avatar" [style.background-color]="getAvatarColor(ficha?.datosPersonales?.nombres, ficha?.datosPersonales?.apellidos)">
            {{ getInitials(ficha?.datosPersonales?.nombres, ficha?.datosPersonales?.apellidos) }}
          </div>
          <div class="header-text">
            <h1>{{ ficha?.datosPersonales?.nombres }} {{ ficha?.datosPersonales?.apellidos }}</h1>
            <p class="patient-rut">{{ ficha?.datosPersonales?.rut }}</p>
          </div>
        </div>
        
        <div class="header-actions">
          <ion-button (click)="nuevaConsulta()" fill="outline" class="nueva-consulta-btn">
            <ion-icon name="add-circle" slot="start"></ion-icon>
            Nueva Consulta
          </ion-button>
          
          <ion-button (click)="subirExamen()" fill="solid" class="subir-examen-btn">
            <ion-icon name="cloud-upload-outline" slot="start"></ion-icon>
            Subir Examen
          </ion-button>
          
          <ion-button (click)="verMedicacion()" fill="outline" class="medicacion-btn">
            <ion-icon name="medical" slot="start"></ion-icon>
            Ver Medicación
          </ion-button>
        </div>
      </div>
      
    </div>

    <!-- SECCIÓN: Datos Personales -->
    <ion-card class="section-card">
      <ion-card-header>
        <div class="section-header">
          <ion-icon name="person" class="section-icon"></ion-icon>
          <ion-card-title>Datos Personales</ion-card-title>
          <div *ngIf="!isEditMode">
            <ion-button (click)="editarDatosPersonales()" fill="outline" size="small" class="edit-btn">
              <ion-icon name="create-outline" slot="start"></ion-icon>
              Editar
            </ion-button>
          </div>
          <div *ngIf="isEditMode" class="edit-actions">
            <ion-button (click)="guardarCambios()" fill="solid" size="small" color="success">
              <ion-icon name="checkmark-outline" slot="start"></ion-icon>
              Guardar
            </ion-button>
            <ion-button (click)="cancelarEdicion()" fill="outline" size="small" color="medium">
              <ion-icon name="close-outline" slot="start"></ion-icon>
              Cancelar
            </ion-button>
          </div>
        </div>
      </ion-card-header>
      
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="12" sizeMd="6">
              <div class="info-group">
                <div class="info-item">
                  <span class="info-label">RUT:</span>
                  <span class="info-value">{{ ficha?.datosPersonales?.rut }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Edad:</span>
                  <span class="info-value">{{ ficha?.datosPersonales?.edad }} años</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Tipo sanguíneo:</span>
                  <span class="info-value blood-type" *ngIf="!isEditMode">{{ ficha?.datosPersonales?.grupoSanguineo }}</span>
                  <ion-select *ngIf="isEditMode" [(ngModel)]="editedData.grupoSanguineo" interface="popover">
                    <ion-select-option value="A+">A+</ion-select-option>
                    <ion-select-option value="A-">A-</ion-select-option>
                    <ion-select-option value="B+">B+</ion-select-option>
                    <ion-select-option value="B-">B-</ion-select-option>
                    <ion-select-option value="AB+">AB+</ion-select-option>
                    <ion-select-option value="AB-">AB-</ion-select-option>
                    <ion-select-option value="O+">O+</ion-select-option>
                    <ion-select-option value="O-">O-</ion-select-option>
                  </ion-select>
                </div>
              </div>
            </ion-col>
            <ion-col size="12" sizeMd="6">
              <div class="info-group">
                <div class="info-item">
                  <span class="info-label">Dirección:</span>
                  <span class="info-value" *ngIf="!isEditMode">{{ ficha?.datosPersonales?.direccion }}</span>
                  <ion-input *ngIf="isEditMode" [(ngModel)]="editedData.direccion" type="text" class="edit-input"></ion-input>
                </div>
                <div class="info-item">
                  <span class="info-label">Contacto:</span>
                  <span class="info-value" *ngIf="!isEditMode">{{ ficha?.datosPersonales?.telefono }}</span>
                  <ion-input *ngIf="isEditMode" [(ngModel)]="editedData.telefono" type="tel" maxlength="9" class="edit-input"></ion-input>
                </div>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- SECCIÓN: Alertas Médicas -->
    <ion-card class="section-card">
      <ion-card-header>
        <div class="section-header">
          <ion-icon name="alert-circle" class="section-icon alert-icon"></ion-icon>
          <ion-card-title>Alertas Médicas</ion-card-title>
        </div>
      </ion-card-header>
      
      <ion-card-content>
        <div class="alerts-container">
          <div class="alerts-group">
            <h4 class="alerts-subtitle">Alergias:</h4>
            <div class="badges-container">
              <ion-badge 
                *ngFor="let alerta of ficha?.alertasMedicas | slice:0:2" 
                [color]="getBadgeColor(alerta.criticidad)"
                class="alert-badge">
                {{ alerta.descripcion }}
              </ion-badge>
            </div>
          </div>
          
          <div class="alerts-group">
            <h4 class="alerts-subtitle">Condiciones Crónicas:</h4>
            <div class="badges-container">
              <ion-badge 
                *ngFor="let alerta of ficha?.alertasMedicas | slice:2:4" 
                [color]="getBadgeColor(alerta.criticidad)"
                class="alert-badge condition-badge">
                {{ alerta.descripcion }}
              </ion-badge>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- SECCIÓN: Evolución Médica con Timeline -->
    <ion-card class="section-card timeline-card">
      <ion-card-header>
        <div class="section-header">
          <ion-icon name="pulse" class="section-icon evolution-icon"></ion-icon>
          <ion-card-title>Historial Médico Completo</ion-card-title>
        </div>
      </ion-card-header>
      
      <ion-card-content>
        <app-timeline 
          [items]="timelineItems"
          [emptyMessage]="'No hay consultas o exámenes registrados'">
        </app-timeline>
      </ion-card-content>
    </ion-card>

    <!-- BOTÓN DESTACADO: Ver Exámenes (igual a tab1) -->
    <ion-card class="panel">
      <ion-card-content>
        <button class="alert-btn"(click)="verExamenes()">
          <ion-icon name="flask"></ion-icon>
          <span>Ver Exámenes</span>
        </button>
      </ion-card-content>
    </ion-card>

    <!-- SECCIÓN: Exámenes y Resultados (resumen) -->
    <ion-card class="section-card">
      <ion-card-header>
        <div class="section-header">
          <ion-icon name="flask" class="section-icon examenes-icon"></ion-icon>
          <ion-card-title>Resumen Exámenes y Resultados</ion-card-title>
        </div>
      </ion-card-header>
      <ion-card-content>
        <div class="examenes-list">
          <div *ngFor="let examen of ficha?.examenes" class="examen-item">
            <div class="examen-header">
              <div class="examen-info">
                <h4 class="examen-name">{{ examen.nombre }}</h4>
                <span class="examen-date">{{ formatDateShort(examen.fecha) }}</span>
              </div>
              <ion-badge [color]="getExamenBadgeColor(examen.estado)" class="examen-badge">
                {{ getExamenBadgeText(examen.estado) }}
              </ion-badge>
            </div>
            <div class="examen-result">
              <span>{{ examen.resultado }}</span>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- SECCIÓN: Notas Rápidas -->
    <ion-card class="section-card">
      <ion-card-header>
        <div class="section-header">
          <ion-icon name="document-outline" class="section-icon notas-icon"></ion-icon>
          <ion-card-title>Notas Rápidas</ion-card-title>
        </div>
      </ion-card-header>
      
      <ion-card-content>
        <div class="notas-container">
          <ion-textarea
            [(ngModel)]="nuevaNota"
            placeholder="Agregar nota rápida sobre el paciente..."
            rows="4"
            fill="outline"
            class="nota-textarea">
          </ion-textarea>
          
          <ion-button 
            (click)="agregarNota()"
            [disabled]="!nuevaNota.trim()"
            color="primary"
            class="agregar-nota-btn">
            <ion-icon name="add" slot="start"></ion-icon>
            Agregar Nota
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

  </div>

  <!-- POPUP OVERLAY: Nueva Consulta -->
  <div *ngIf="showConsultaPopup" class="popup-overlay" (click)="cerrarPopupConsulta()">
    <div class="popup-content popup-large" (click)="$event.stopPropagation()">
      <button class="close-btn" (click)="cerrarPopupConsulta()">
        <ion-icon name="close"></ion-icon>
      </button>
      
      <div class="popup-body">
        <h2>Nueva Consulta</h2>
        <p class="patient-info">Paciente: {{ paciente?.nombre }} {{ paciente?.apellido }}</p>
        
        <!-- Fecha de Consulta -->
        <div class="form-group">
          <label>Fecha de Consulta *</label>
          <ion-datetime-button datetime="datetime-consulta"></ion-datetime-button>
          <ion-modal [keepContentsMounted]="true">
            <ng-template>
              <ion-datetime 
                id="datetime-consulta"
                [(ngModel)]="datosNuevaConsulta.fechaConsulta"
                presentation="date-time"
                [max]="maxDate"
                locale="es-CL">
              </ion-datetime>
            </ng-template>
          </ion-modal>
        </div>

        <!-- Motivo de Consulta -->
        <div class="form-group">
          <label>Motivo de Consulta *</label>
          <ion-textarea
            [(ngModel)]="datosNuevaConsulta.motivoConsulta"
            placeholder="Ej: Dolor abdominal, control de presión, seguimiento..."
            rows="3"
            fill="outline"
            [class.ion-invalid]="formSubmitted && !datosNuevaConsulta.motivoConsulta.trim()"
          ></ion-textarea>
          <div class="error-message" *ngIf="formSubmitted && !datosNuevaConsulta.motivoConsulta.trim()">
            El motivo de consulta es obligatorio
          </div>
        </div>

        <!-- Diagnóstico -->
        <div class="form-group">
          <label>Diagnóstico</label>
          <ion-textarea
            [(ngModel)]="datosNuevaConsulta.diagnostico"
            placeholder="Ej: Hipertensión arterial esencial, Diabetes tipo 2..."
            rows="2"
            fill="outline"
          ></ion-textarea>
        </div>

        <!-- Tratamiento -->
        <div class="form-group">
          <label>Tratamiento</label>
          <ion-textarea
            [(ngModel)]="datosNuevaConsulta.tratamiento"
            placeholder="Ej: Enalapril 10mg cada 12hrs, control en 15 días..."
            rows="3"
            fill="outline"
          ></ion-textarea>
        </div>

        <!-- Signos Vitales -->
        <div class="section-divider">
          <label>Signos Vitales</label>
        </div>

        <ion-grid>
          <ion-row>
            <ion-col size="12" sizeMd="6">
              <div class="form-group">
                <label>Presión Arterial (mmHg)</label>
                <ion-input
                  [(ngModel)]="datosNuevaConsulta.signosVitales.presionArterial"
                  type="text"
                  placeholder="Ej: 120/80"
                  fill="outline"
                ></ion-input>
              </div>
            </ion-col>

            <ion-col size="12" sizeMd="6">
              <div class="form-group">
                <label>Frecuencia Cardíaca (lpm)</label>
                <ion-input
                  [(ngModel)]="datosNuevaConsulta.signosVitales.frecuenciaCardiaca"
                  type="number"
                  placeholder="Ej: 72"
                  fill="outline"
                ></ion-input>
              </div>
            </ion-col>

            <ion-col size="12" sizeMd="6">
              <div class="form-group">
                <label>Temperatura (°C)</label>
                <ion-input
                  [(ngModel)]="datosNuevaConsulta.signosVitales.temperatura"
                  type="text"
                  placeholder="Ej: 36.5"
                  fill="outline"
                ></ion-input>
              </div>
            </ion-col>

            <ion-col size="12" sizeMd="6">
              <div class="form-group">
                <label>Saturación O2 (%)</label>
                <ion-input
                  [(ngModel)]="datosNuevaConsulta.signosVitales.saturacionOxigeno"
                  type="number"
                  placeholder="Ej: 98"
                  fill="outline"
                ></ion-input>
              </div>
            </ion-col>

            <ion-col size="12" sizeMd="6">
              <div class="form-group">
                <label>Peso (kg)</label>
                <ion-input
                  [(ngModel)]="datosNuevaConsulta.signosVitales.peso"
                  type="text"
                  placeholder="Ej: 75.5"
                  fill="outline"
                ></ion-input>
              </div>
            </ion-col>

            <ion-col size="12" sizeMd="6">
              <div class="form-group">
                <label>Talla (cm)</label>
                <ion-input
                  [(ngModel)]="datosNuevaConsulta.signosVitales.talla"
                  type="text"
                  placeholder="Ej: 170"
                  fill="outline"
                ></ion-input>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>

        <!-- Observaciones -->
        <div class="form-group">
          <label>Observaciones</label>
          <ion-textarea
            [(ngModel)]="datosNuevaConsulta.observaciones"
            placeholder="Notas adicionales..."
            rows="2"
            fill="outline"
          ></ion-textarea>
        </div>

        <div class="popup-actions">
          <button class="btn-secondary" (click)="cerrarPopupConsulta()">
            Cancelar
          </button>
          <button 
            class="btn-primary" 
            (click)="confirmarNuevaConsulta()"
            [disabled]="!isConsultaFormValid()"
          >
            Guardar Consulta
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- POPUP OVERLAY: Subir Examen -->
  <div *ngIf="showExamenPopup" class="popup-overlay" (click)="cerrarPopupExamen()">
    <div class="popup-content" (click)="$event.stopPropagation()">
      <button class="close-btn" (click)="cerrarPopupExamen()">
        <ion-icon name="close"></ion-icon>
      </button>
      
      <div class="popup-body">
        <h2>Subir Resultado de Examen</h2>
        <p class="patient-info">Paciente: {{ paciente?.nombre }} {{ paciente?.apellido }}</p>
        
        <div class="form-group">
          <label>Nombre del Examen *</label>
          <ion-input
            [(ngModel)]="nuevoExamen.nombreExamen"
            placeholder="Ej: Hemograma, Radiografía..."
            fill="outline"
          ></ion-input>
        </div>

        <div class="form-group">
          <label>Tipo de Examen</label>
          <ion-select
            [(ngModel)]="nuevoExamen.tipoExamen"
            placeholder="Selecciona un tipo"
            fill="outline"
          >
            <ion-select-option value="laboratorio">Laboratorio</ion-select-option>
            <ion-select-option value="imagen">Imagen (Radiografía, TAC, etc.)</ion-select-option>
            <ion-select-option value="biopsia">Biopsia</ion-select-option>
            <ion-select-option value="funcional">Funcional (ECG, Espirometría, etc.)</ion-select-option>
            <ion-select-option value="otro">Otro</ion-select-option>
          </ion-select>
        </div>

        <div class="form-group">
          <label>Resultado (Opcional)</label>
          <ion-textarea
            [(ngModel)]="nuevoExamen.resultado"
            placeholder="Describe brevemente el resultado..."
            rows="3"
            fill="outline"
          ></ion-textarea>
        </div>

        <div class="popup-actions">
          <button class="btn-secondary" (click)="cerrarPopupExamen()">
            Cancelar
          </button>
          <button 
            class="btn-primary" 
            (click)="guardarExamen()"
            [disabled]="!nuevoExamen.nombreExamen"
          >
            Guardar
          </button>
        </div>
      </div>
    </div>
  </div>

</ion-content>
